---
id: QC-026.07
title: Agent Open/Close Project
status: To Do
assignee: []
created_date: '2026-02-05 10:00'
labels:
  - interface
  - projects
  - agent-tools
  - P2
dependencies:
  - QC-026.05
parent_task_id: QC-026
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
As an AI Agent, I want to open and close QualCoder projects so that I can autonomously manage the project lifecycle during automated workflows (e.g., batch analysis, CI pipelines, headless operation).

Currently the agent can query project context (`get_project_context`) and navigate within an open project, but cannot open or close projects programmatically. This blocks headless/automated agent workflows.

**Trust Level:** T2 (Notify) — Agent acts, researcher informed post-action. Opening/closing projects is a safe, reversible operation. The researcher is notified but no approval is required.

**Bounded Context:** Projects
**Layer:** Interface (MCP tools) → calls existing `open_project` / `close_project` command handlers
<!-- SECTION:DESCRIPTION:END -->

## Acceptance Criteria
<!-- AC:BEGIN -->
- [ ] #1 MCP tool `open_project` is registered with `path` as required parameter
- [ ] #2 Agent can open a `.qda` project file by providing its absolute path
- [ ] #3 Invalid or non-existent paths return clear failure messages matching `ProjectNotOpened` failure events
- [ ] #4 `ProjectOpened` domain event is published on success
- [ ] #5 MCP tool `close_project` is registered (no parameters required)
- [ ] #6 Agent can close the currently open project
- [ ] #7 Closing when no project is open returns an informative message (not an error)
- [ ] #8 `ProjectClosed` domain event is published on close
- [ ] #9 E2E test exists with `@allure.story("QC-026.07 Agent Open/Close Project")` decorator
<!-- AC:END -->

## Implementation

### Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/contexts/projects/interface/mcp_tools.py` | Modify | Add `open_project` and `close_project` tool definitions and handlers |
| `src/tests/e2e/test_agent_project_lifecycle_e2e.py` | Create | E2E test for agent project lifecycle |

### MCP Tool Schemas

**open_project:**
```json
{
  "name": "open_project",
  "description": "Open an existing QualCoder project file (.qda). Closes any currently open project first.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "path": {
        "type": "string",
        "description": "Absolute path to the .qda project file"
      }
    },
    "required": ["path"]
  }
}
```

**close_project:**
```json
{
  "name": "close_project",
  "description": "Close the currently open project. Safe to call when no project is open.",
  "inputSchema": {
    "type": "object",
    "properties": {},
    "required": []
  }
}
```

### Domain Flow

```
open_project(path)
  → validate path (invariants: exists, .qda extension, valid database)
  → close current project if open
  → derive ProjectOpened or ProjectNotOpened event
  → update ProjectState
  → publish ProjectOpened event to EventBus
  → return Success({project_name, project_path, source_count})

close_project()
  → if no project open: return Success({message: "No project open"})
  → derive ProjectClosed event
  → clear ProjectState
  → publish ProjectClosed event to EventBus
  → return Success({closed: true, project_name})
```

## Notes

- Reuses existing `open_project` and `close_project` command handlers from `src/contexts/projects/core/commandHandlers/`
- When opening a project, any currently open project is closed first (matching UI behavior)
- The `close_project` tool is idempotent — calling it with no project open is safe
