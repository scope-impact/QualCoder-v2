---
id: QC-027.13
title: Agent Manage Folders
status: Done
assignee:
  - '@claude'
created_date: '2026-02-05 10:00'
labels:
  - interface
  - sources
  - agent-tools
  - P2
dependencies:
  - QC-027.08
  - QC-027.12
parent_task_id: QC-027
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
As an AI Agent, I want to create, list, rename, and delete source folders, and move sources between folders, so that I can programmatically organize research data into meaningful groups.

Currently the agent can list sources but has no way to organize them into folders. The domain layer (`folders` bounded context) already has command handlers for all folder operations — this task exposes them as MCP tools.

**Trust Level:** T3 (Suggest) — Agent proposes folder organization, researcher approves. Folder operations are reversible but affect the researcher's organizational structure.

**Bounded Context:** Sources / Folders
**Layer:** Interface (MCP tools) → calls existing folder command handlers
<!-- SECTION:DESCRIPTION:END -->

## Acceptance Criteria
<!-- AC:BEGIN -->
- [x] #1 MCP tool `list_folders` returns all folders with id, name, parent_id hierarchy
- [x] #2 MCP tool `create_folder` accepts name and optional parent_id, returns new folder ID
- [x] #3 Duplicate folder names within same parent are rejected with clear failure message
- [x] #4 MCP tool `rename_folder` accepts folder_id and new_name
- [x] #5 MCP tool `delete_folder` accepts folder_id, rejects if folder contains sources
- [x] #6 MCP tool `move_source_to_folder` accepts source_id and target folder_id
- [x] #7 All tools publish corresponding domain events (FolderCreated, FolderRenamed, FolderDeleted, SourceMovedToFolder)
- [x] #8 E2E test exists with `@allure.story("QC-027.13 Agent Manage Folders")` decorator
<!-- AC:END -->

## Implementation

### Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `src/contexts/projects/interface/mcp_tools.py` | Modify | Add folder management tool definitions and handlers |
| `src/tests/e2e/test_agent_manage_folders_e2e.py` | Create | E2E tests for agent folder management |

### MCP Tool Schemas

**list_folders:**
```json
{
  "name": "list_folders",
  "description": "List all source folders in the current project, including hierarchy.",
  "inputSchema": {
    "type": "object",
    "properties": {},
    "required": []
  }
}
```

**create_folder:**
```json
{
  "name": "create_folder",
  "description": "Create a new folder for organizing sources.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "name": {
        "type": "string",
        "description": "Folder name (must be unique within parent)"
      },
      "parent_id": {
        "type": "integer",
        "description": "Parent folder ID for nesting. Omit for root-level folder."
      }
    },
    "required": ["name"]
  }
}
```

**rename_folder:**
```json
{
  "name": "rename_folder",
  "description": "Rename an existing folder.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "folder_id": { "type": "integer", "description": "ID of the folder to rename" },
      "new_name": { "type": "string", "description": "New folder name" }
    },
    "required": ["folder_id", "new_name"]
  }
}
```

**delete_folder:**
```json
{
  "name": "delete_folder",
  "description": "Delete an empty folder. Fails if folder contains sources.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "folder_id": { "type": "integer", "description": "ID of the folder to delete" }
    },
    "required": ["folder_id"]
  }
}
```

**move_source_to_folder:**
```json
{
  "name": "move_source_to_folder",
  "description": "Move a source into a folder for organization.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "source_id": { "type": "integer", "description": "ID of the source to move" },
      "folder_id": { "type": "integer", "description": "Target folder ID. Use null or 0 for root." }
    },
    "required": ["source_id", "folder_id"]
  }
}
```

### Domain Flow

```
list_folders()
  → FolderRepository.get_all()
  → return Success({folders: [{id, name, parent_id, created_at}, ...]})

create_folder(name, parent_id?)
  → validate name uniqueness within parent (invariant)
  → derive FolderCreated or FolderNotCreated
  → persist Folder entity
  → publish FolderCreated event
  → return Success({folder_id, name, parent_id})

move_source_to_folder(source_id, folder_id)
  → validate source exists, folder exists
  → derive SourceMovedToFolder or SourceNotMoved
  → update Source.folder_id
  → publish SourceMovedToFolder event
  → return Success({source_id, folder_id})
```

## Notes

- Delegates to existing command handlers in `src/contexts/folders/core/commandHandlers/`
- Folder hierarchy is flat (one level of nesting via parent_id) in the current schema
- `delete_folder` enforces the "folder not empty" invariant — agent must move sources out first
