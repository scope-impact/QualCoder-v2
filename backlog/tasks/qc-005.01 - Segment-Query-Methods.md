---
id: QC-005.01
title: Segment Query Methods
status: To Do
assignee: []
created_date: '2026-01-29 16:38'
labels:
  - infrastructure
  - coding
  - P0
dependencies: []
parent_task_id: QC-005
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
Add repository methods for querying segments by source and detecting overlaps. Required for text highlighting and overlap detection.
<!-- SECTION:DESCRIPTION:END -->

## Acceptance Criteria
<!-- AC:BEGIN -->
### Repository Methods (SegmentRepository)
- [ ] #1 `find_by_source_id(source_id: SourceId) -> List[Segment]` - returns all segments for a source, ordered by position
- [ ] #2 `find_overlapping(source_id: SourceId, position: TextPosition) -> List[Segment]` - returns segments overlapping given range
- [ ] #3 `find_by_code_id(code_id: CodeId) -> List[Segment]` - returns all segments with given code
- [ ] #4 `count_by_code_id(code_id: CodeId) -> int` - returns count without loading entities

### Query DTOs (Read-only, for CQRS-lite read path)
- [ ] #5 `SegmentWithCode` DTO: segment_id, source_id, position, code_id, code_name, code_color
- [ ] #6 `find_by_source_with_codes(source_id) -> List[SegmentWithCode]` - single query joining segment + code

### Performance
- [ ] #7 Indexed queries: source_id, code_id columns indexed in SQLite
- [ ] #8 Position overlap query uses efficient range comparison (start < end AND end > start)

### Immutability
- [ ] #9 All returned entities are frozen dataclasses (domain entities, not ORM objects)
- [ ] #10 Repository converts SQLite rows â†’ domain entities via factory functions
<!-- AC:END -->
