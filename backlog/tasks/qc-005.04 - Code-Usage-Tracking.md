---
id: QC-005.04
title: Code Usage Tracking
status: To Do
assignee: []
created_date: '2026-01-29 16:38'
labels:
  - infrastructure
  - coding
  - P2
dependencies: []
parent_task_id: QC-005
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
Track code usage history for recent codes feature. Store last-used timestamp per code.
<!-- SECTION:DESCRIPTION:END -->

## Acceptance Criteria
<!-- AC:BEGIN -->
### Schema Changes
- [ ] #1 Add `last_used_at: datetime` column to code_name table (nullable for backwards compatibility)
- [ ] #2 Migration script to add column with default NULL for existing codes
- [ ] #3 Index on `last_used_at DESC` for efficient recent query

### Repository Methods (CodeRepository)
- [ ] #4 `update_last_used(code_id: CodeId, timestamp: datetime) -> None` - updates usage timestamp
- [ ] #5 `find_recent(limit: int) -> List[Code]` - returns codes ordered by last_used_at DESC NULLS LAST

### Event Handler (Policy)
- [ ] #6 `on_segment_coded(event: SegmentCoded)` policy updates last_used_at for event.code_id
- [ ] #7 Policy subscribes to SegmentCoded event via Event Bus

### Immutability Note
- [ ] #8 `last_used_at` is infrastructure concern, not part of domain Code entity
- [ ] #9 Code entity remains pure; tracking is repository/policy responsibility
<!-- AC:END -->
