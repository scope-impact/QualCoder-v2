---
id: QC-047.02
title: CodesPanel Flat List Refactor
status: To Do
parent: QC-047
layer: Presentation
created_date: '2026-02-04'
labels: [presentation, coding, refactor, P1]
dependencies: []
---

## Description

Simplify CodesPanel from hierarchical tree with action buttons to a flat list showing code name, color dot, and usage count.

**Current Structure:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Codes    [+][ðŸ”][â–¼] â”‚  â† header with actions
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¼ Category A        â”‚  â† expandable tree
â”‚   â€¢ Code 1          â”‚
â”‚   â€¢ Code 2          â”‚
â”‚ â–¶ Category B        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [â—€][â–¶] Navigation   â”‚  â† navigation buttons
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Target Structure:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CODES            â† â”‚  â† simple header with collapse toggle
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â— Education      12 â”‚  â† flat list with color dots
â”‚ â— Family Dyn.     8 â”‚
â”‚ â— Health         15 â”‚
â”‚ â— Leisure         5 â”‚
â”‚ â— Linguistic      3 â”‚
â”‚ â— Phone Usage     9 â”‚
â”‚ â— Social Media    7 â”‚
â”‚ â— Digital Trust   4 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Effort Estimate:** 6-10 hours (Medium)

## Acceptance Criteria

- [ ] Flat list displays all codes (no hierarchy/categories visible)
- [ ] Each row shows: color dot, code name, usage count
- [ ] "â†" arrow in header collapses/hides the panel
- [ ] Code selection works (click to select for quick-apply)
- [ ] Selected code visually highlighted
- [ ] Preserves recent codes tracking (for keyboard shortcut R)
- [ ] Remove action buttons (+, search, expand all) from header
- [ ] Remove navigation buttons from footer
- [ ] Scrollable list for many codes

## Implementation

### Files to Modify

1. **`src/shared/presentation/organisms/codes_panel.py`** (398 lines)
   - Replace `CodeTree` with flat `QListWidget` or custom list
   - Simplify `PanelHeader` to just title + collapse toggle
   - Remove footer navigation buttons
   - Update styling for flat list appearance

2. **`src/contexts/coding/presentation/screens/text_coding.py`**
   - Update signal connections for new codes panel API
   - Ensure `code_selected` signal still works

### Component Structure

```python
class CodesPanel(QFrame):
    """Simplified flat code list panel"""

    code_selected = Signal(dict)  # {id, name, color}
    collapse_clicked = Signal()

    def __init__(self, colors: ColorPalette, parent=None):
        # Header: "CODES" + collapse arrow
        # List: FlatCodeList widget
        pass

    def set_codes(self, codes: list[CodeDTO]):
        """Update the flat list with codes"""
        pass

    def set_selected_code(self, code_id: int | None):
        """Highlight the selected code"""
        pass


class FlatCodeList(QListWidget):
    """Flat scrollable list of codes with color dots"""

    def add_code(self, code_id: int, name: str, color: str, count: int):
        # Create list item with:
        # - Colored dot (QLabel with background)
        # - Code name (QLabel)
        # - Count (QLabel, right-aligned)
        pass
```

### Code Item Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [â—]  Code Name                   12 â”‚
â”‚ 8px  flex-grow               32px   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Styling

```python
# Color dot
dot_style = f"""
    QLabel {{
        background-color: {code.color};
        border-radius: 6px;
        min-width: 12px;
        max-width: 12px;
        min-height: 12px;
        max-height: 12px;
    }}
"""

# Selected item
selected_style = f"""
    background-color: {colors.surface_light};
    border-left: 3px solid {colors.primary};
"""
```

## Technical Notes

### Data Flow

```
ViewModel.codes_changed(list[CodeDTO])
    â†“
CodesPanel.set_codes(codes)
    â†“
FlatCodeList renders each code as row
    â†“
User clicks code â†’ code_selected signal
    â†“
TextCodingScreen handles selection for quick-apply
```

### What to Preserve

- `code_selected` signal signature
- Recent codes list (used by keyboard shortcut R)
- Integration with ViewModel's `load_codes()` method

### What to Remove

- Code categories/hierarchy display
- "+" create code button (move to toolbar or menu)
- Search filter input
- Expand/collapse all buttons
- Previous/next navigation buttons

### Categories Data

Categories still exist in the domain model - they're just not displayed in the flat list. The list shows all codes from all categories, sorted alphabetically or by usage count.

```python
def flatten_codes(categories: list[CodeCategoryDTO]) -> list[CodeDTO]:
    """Extract all codes from categories into flat list"""
    codes = []
    for category in categories:
        codes.extend(category.codes)
    return sorted(codes, key=lambda c: c.name.lower())
```
