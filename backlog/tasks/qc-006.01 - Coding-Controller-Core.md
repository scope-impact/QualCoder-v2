---
id: QC-006.01
title: Coding Controller Core
status: To Do
assignee: []
created_date: '2026-01-30'
labels:
  - application
  - coding
  - P0
dependencies: [QC-004, QC-005]
parent_task_id: QC-006
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
Implement the core CodingController with basic CRUD commands for codes, categories, and text segments. This is the orchestration layer that connects UI/Agent to Domain and Infrastructure.
<!-- SECTION:DESCRIPTION:END -->

## Acceptance Criteria
<!-- AC:BEGIN -->

### Controller Class
- [ ] #1 `CodingController` class in Application layer
- [ ] #2 Constructor accepts: `code_repo`, `category_repo`, `segment_repo`, `event_bus`
- [ ] #3 Single instance shared between UI and Agent (via dependency injection)

### Code Commands
- [ ] #4 `create_code(name, color, category_id?) -> Result[CodeCreated, Failure]`
- [ ] #5 `rename_code(code_id, new_name) -> Result[CodeRenamed, Failure]`
- [ ] #6 `change_code_color(code_id, new_color) -> Result[CodeColorChanged, Failure]`
- [ ] #7 `delete_code(code_id) -> Result[CodeDeleted, Failure]`
- [ ] #8 `merge_codes(source_code_id, target_code_id) -> Result[CodesMerged, Failure]`
- [ ] #9 `move_code_to_category(code_id, category_id?) -> Result[CodeMovedToCategory, Failure]`

### Category Commands
- [ ] #10 `create_category(name, parent_id?) -> Result[CategoryCreated, Failure]`
- [ ] #11 `rename_category(category_id, new_name) -> Result[CategoryRenamed, Failure]`
- [ ] #12 `delete_category(category_id) -> Result[CategoryDeleted, Failure]`
- [ ] #13 `move_category(category_id, new_parent_id?) -> Result[CategoryMoved, Failure]`

### Text Segment Commands
- [ ] #14 `apply_code_to_text(code_id, source_id, position: TextPosition) -> Result[SegmentCoded, Failure]`
- [ ] #15 `remove_text_segment(segment_id) -> Result[SegmentUncoded, Failure]`
- [ ] #16 `update_segment_memo(segment_id, memo) -> Result[SegmentMemoUpdated, Failure]`
- [ ] #17 `set_segment_importance(segment_id, importance) -> Result[SegmentImportanceSet, Failure]`

### Controller Flow Pattern (for each command)
- [ ] #18 Fetch current state from repositories
- [ ] #19 Call domain deriver with command + state
- [ ] #20 On Success: persist via repository, publish event to EventBus
- [ ] #21 On Failure: return Failure, no side effects

### Query Methods (read-only)
- [ ] #22 `get_all_codes() -> List[Code]`
- [ ] #23 `get_all_categories() -> List[Category]`
- [ ] #24 `get_segments_for_source(source_id) -> List[Segment]`
- [ ] #25 `get_segments_for_code(code_id) -> List[Segment]`

<!-- AC:END -->

## Implementation Notes

**fDDD Pattern:**
```python
class CodingController:
    def create_code(self, name: str, color: Color, category_id: CategoryId | None = None) -> Result[CodeCreated, Failure]:
        # 1. Build state from repos
        state = CodingState(
            existing_codes=tuple(self.code_repo.get_all()),
            existing_categories=tuple(self.category_repo.get_all()),
        )

        # 2. Call pure deriver
        result = derive_create_code(name, color, category_id, state)

        # 3. Handle result
        match result:
            case CodeCreated() as event:
                self.code_repo.save_from_event(event)
                self.event_bus.publish(event)
                return Success(event)
            case Failure() as failure:
                return failure
```

## Files

- `src/application/controllers/coding_controller.py`
