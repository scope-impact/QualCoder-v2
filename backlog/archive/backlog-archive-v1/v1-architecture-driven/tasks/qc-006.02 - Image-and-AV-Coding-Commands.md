---
id: QC-006.02
title: Image and AV Coding Commands
status: To Do
assignee: []
created_date: '2026-01-29 16:38'
labels:
  - application
  - coding
  - image-coding
  - av-coding
  - P1
dependencies: []
parent_task_id: QC-006
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
Implement controller commands for image region and A/V time range coding. Publishes media-specific events.
<!-- SECTION:DESCRIPTION:END -->

## Acceptance Criteria
<!-- AC:BEGIN -->
### Controller Commands (Imperative Shell)
- [ ] #1 `apply_code_to_image(code_id, source_id, region: ImageRegion) -> Result[ImageSegmentCoded, Failure]`
- [ ] #2 `apply_code_to_av(code_id, source_id, time_range: TimeRange, transcript: Optional[str]) -> Result[AVSegmentCoded, Failure]`
- [ ] #3 `remove_image_segment(segment_id) -> Result[ImageSegmentUncoded, Failure]`
- [ ] #4 `remove_av_segment(segment_id) -> Result[AVSegmentUncoded, Failure]`

### Deriver Functions (Pure, in Functional Core)
- [ ] #5 `derive_image_segment(code_id, source_id, region, owner) -> Result[ImageSegment, Failure]`
  - Checks: is_code_exists, is_source_image_type, is_region_within_bounds
- [ ] #6 `derive_av_segment(code_id, source_id, time_range, transcript, owner) -> Result[AVSegment, Failure]`
  - Checks: is_code_exists, is_source_av_type, is_time_range_valid

### Invariants (Pure predicate functions)
- [ ] #7 `is_source_image_type(source: Source) -> bool` - validates source is ImageSource
- [ ] #8 `is_source_av_type(source: Source) -> bool` - validates source is AudioSource or VideoSource
- [ ] #9 `is_region_within_bounds(region, source) -> bool` - x+width <= source.width, y+height <= source.height
- [ ] #10 `is_time_range_within_duration(time_range, source) -> bool` - end_ms <= source.duration_ms

### Controller Flow
- [ ] #11 Controller: fetch state → call deriver → on success: persist + publish event
- [ ] #12 Publishes media-specific events (ImageSegmentCoded, AVSegmentCoded) to Event Bus
<!-- AC:END -->
