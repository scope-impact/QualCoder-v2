---
id: QC-007.21
title: ViewModel Integration
status: Done
assignee: []
created_date: '2026-01-30'
labels:
  - presentation
  - coding
  - text-coding
  - P0
dependencies: [QC-007.01, QC-006.01]
parent_task_id: QC-007
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
Wire the presentation layer to the application layer via TextCodingViewModel. This is the critical "glue" that connects UI signals to domain operations. Without this, code application workflows exist in the UI but don't persist to the database.
<!-- SECTION:DESCRIPTION:END -->

## Acceptance Criteria
<!-- AC:BEGIN -->

### Text Selection Capture
- [x] #1 TextEditorPanel emits `text_selected(start, end, text)` when user selects text
- [ ] #2 Selection popup appears on text selection (deferred to QC-007.04)
- [x] #3 Clearing selection emits `text_deselected` signal

### ViewModel Command Methods
- [x] #4 `apply_code_to_selection(code_id, source_id, start, end)` calls controller.apply_code()
- [x] #5 `remove_segment(segment_id)` calls controller.remove_code()
- [x] #6 `create_code(name, color)` calls controller.create_code()
- [x] #7 All methods return Result for error handling

### Screen-to-ViewModel Wiring
- [x] #8 Screen `code_applied` signal routes to viewmodel.apply_code_to_selection()
- [x] #9 Screen `code_removed` signal routes to viewmodel.remove_segment()
- [ ] #10 Screen `code_created` signal routes to viewmodel.create_code() (deferred to QC-007.02 V-key)

### ViewModel-to-Screen Wiring
- [x] #11 ViewModel `codes_changed` signal updates CodesPanel
- [x] #12 ViewModel `segments_changed` signal updates TextEditorPanel highlights
- [x] #13 ViewModel `error_occurred` signal emits on failure

### Source Document Tracking
- [x] #14 Screen tracks `_source_id` for current document
- [x] #15 `set_current_source(source_id)` method updates tracking
- [x] #16 ViewModel receives source_id with each operation

<!-- AC:END -->

## Implementation Notes

**Signal Flow:**
```
User selects text → TextEditorPanel.text_selected
                  → Screen enables quick-mark
User presses Q    → Screen.quick_mark()
                  → Screen.code_applied.emit(code_id, start, end)
                  → ViewModel.apply_code_to_selection()
                  → Controller.apply_code()
                  → Repository.save()
                  → EventBus.publish(SegmentCoded)
                  → SignalBridge.segment_coded.emit()
                  → ViewModel.segments_changed.emit()
                  → Screen._on_segments_changed()
                  → TextEditorPanel.highlight_range()
```

**Files:**
- `src/presentation/organisms/text_editor_panel.py` - add selection signals
- `src/presentation/viewmodels/text_coding_viewmodel.py` - implement methods
- `src/presentation/screens/text_coding.py` - wire signals

## Files

- `src/presentation/organisms/text_editor_panel.py`
- `src/presentation/viewmodels/text_coding_viewmodel.py`
- `src/presentation/screens/text_coding.py`
