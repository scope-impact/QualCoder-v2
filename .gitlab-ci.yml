stages:
  - lint
  - test

variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.cache/uv"
  QT_QPA_PLATFORM: "offscreen"

cache:
  key: "${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}"
  paths:
    - .cache/pip
    - .cache/uv
    - .venv

.uv-setup: &uv-setup
  before_script:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv python install $PYTHON_VERSION
    - uv sync --dev

lint:
  stage: lint
  image: python:${PYTHON_VERSION}-slim
  <<: *uv-setup
  script:
    - uv run ruff check .
    - uv run ruff format --check .

test:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  <<: *uv-setup
  before_script:
    - apt-get update && apt-get install -y
        libegl1
        libopengl0
        libxkbcommon0
        libxcb-cursor0
        libxcb-icccm4
        libxcb-keysyms1
        libxcb-shape0
        curl
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv python install $PYTHON_VERSION
    - uv sync --dev
  script:
    - uv run --with pytest-cov pytest
        --cov=src
        --cov=design_system
        --cov-report=term-missing
        --cov-report=xml:coverage.xml
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  coverage: '/TOTAL.*\s+(\d+%)$/'
